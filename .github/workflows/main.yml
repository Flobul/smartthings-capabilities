name: "Generate capabilities"

on:
  workflow_dispatch
jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write

    steps:
      - name: "Checkout files"
        uses: actions/checkout@v3

      - name: "List json directory"
        run: |
          ls ${GITHUB_WORKSPACE}/json/*.json | wc -l
          rm ${GITHUB_WORKSPACE}/json/*.json

      - name: "Setup smartthings-cli"
        run: |
          wget "https://github.com/SmartThingsCommunity/smartthings-cli/releases/download/%40smartthings%2Fcli%401.8.2/smartthings-linux-x64.tar.gz"
          tar -xvf smartthings-linux-x64.tar.gz

      - name: "Use first secret"
        run: |
          SMARTTHINGS_TOKEN=$(echo ${{ secrets.SMARTTHINGS_TOKENS }} | head -n 1)
          echo "SMARTTHINGS_TOKEN=$SMARTTHINGS_TOKEN" >> $GITHUB_ENV

      - name: "Download smartthings capabilities"
        run: |
          ./smartthings capabilities -s -j --token "${{ env.SMARTTHINGS_TOKEN }}" -o capabilities.json
          CAPABILITIES=$(cat capabilities.json)
          echo "CAPABILITIES=${{ env.CAPABILITIES }}" >> $GITHUB_ENV
          cat capabilities.json

      - name: "Process each capability"
        run: |
          echo '${{ env.CAPABILITIES }}' | jq -c '.[]' | while read capability; do
            id=$(echo $capability | jq -r '.id')
            version=$(echo $capability | jq -r '.version')
            echo $id $version
            ./smartthings capabilities $id -s -j --token ${{ env.SMARTTHINGS_TOKEN }} > ${GITHUB_WORKSPACE}/json/$id.json
            ./smartthings capabilities:translations $id $version fr -j --token ${{ env.SMARTTHINGS_TOKEN }} -o ${GITHUB_WORKSPACE}/json/$id.i18n.fr.json
            ./smartthings capabilities:translations $id $version en -j --token ${{ env.SMARTTHINGS_TOKEN }} -o ${GITHUB_WORKSPACE}/json/$id.i18n.en.json
          done

      - name: "List json directory"
        run: |
          ls ${GITHUB_WORKSPACE}/json/*.json | wc -l

      - name: "Create Pull Request"
        uses: peter-evans/create-pull-request@v6
        with:
          add-paths: 'json/*.json'
          branch: update
          delete-branch: true
          title: "Update capabilities"
          body: "Automated capabilities update"
          commit-message: "Auto update capabilities"
